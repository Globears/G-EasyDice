<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="GBK">
    <title>EasyDice</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        .container {
            margin-top: 30px;
            text-align: left;
            align-items: center;
        }

        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* 调整输入框宽度 */
        #diceInput {
            font: bold;
            width: 150px;  /* 原200px调整为150px */
            height: 30px;
        }
        #diceInput::placeholder{
            color: #9E9E9E;  /* 占位符颜色 */
            font-style: italic;  /* 斜体样式 */
        }

        /* Roll按钮专用样式 */
        #rollButton {
            background-color: #304556;  /* 蓝色区分操作按钮 */
            height: 30px;
            padding: 0px 20px;
        }
        #rollButton:hover {
            background-color: #1976D2;  /* 深蓝色悬停效果 */
        }

        #clearButton {
            background-color: #F44336;  /* 红色清除按钮 */
            height: 30px;
            padding: 0px 20px;
        }

        #resultOutput {
            width: 250px;
            height: 80px;
            padding: 15px;
            margin-top: 10px;
            font-size: 18px;
            border: 2px solid #9C27B0;
            border-radius: 8px;
            background-color: #f8f8f8;
            resize: none;
            white-space: pre-wrap;
        }

        input {
            width: 200px;
            font-size: 16px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
        } 

        .dice-buttons {
            display: flex;
            flex-wrap: wrap;
            max-width: 300px;
            align-items: left;
            gap: 10px;
            border-radius: 2px;
        }
        .dice-button {
            height: 40px;
            width: 80px;
            padding: 0px 10px;
            text-align: center;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-group">
            <input type="text" id="diceInput" placeholder="d20 + 2d6 -3...">
            <button id="rollButton">ROLL</button>
            <button id="clearButton">CLEAR</button>
        </div>
        <textarea id="resultOutput" readonly></textarea>
        <div class="dice-buttons">
            <button class="dice-button" id="d20">d20</button>
            <button class="dice-button" id="d10">d10</button>
            <button class="dice-button" id="d8">d8</button>
            <button class="dice-button" id="d6">d6</button>
            <button class="dice-button" id="d4">d4</button>
            <button class="dice-button" id="d100">d100</button>
        </div>
    </div>

    <script>
        const diceInput = document.getElementById('diceInput');
        const diceOutput = document.getElementById('resultOutput');
        
        function parseDiceExpression(expression) {
            // 移除所有空格并拆分表达式为带符号的项
            const cleaned = expression.replace(/\s+/g, '');
            const terms = cleaned.split(/(?=[+-])/g);

            let total = 0;
            const expandedTerms = [];

            for (const term of terms) {
                // 提取符号和内容
                let sign = '+';
                let content = term;
                if (['+', '-'].includes(term[0])) {
                    sign = term[0];
                    content = term.slice(1);
                }

                // 处理骰子项或常数项
                const diceMatch = content.match(/^(\d*)d(\d+)$/i);

                if (diceMatch) {
                    // 解析骰子数量和面数
                    const times = diceMatch[1] ? parseInt(diceMatch[1], 10) : 1;
                    const sides = parseInt(diceMatch[2], 10);
      
                    // 生成骰子结果并计算总和
                    
                    for (let i = 0; i < times; i++) {
                        let res = Math.floor(Math.random() * sides) + 1;
                        let termValue = sign === '+' ? res : -res;
                        expandedTerms.push(termValue);
                        total += termValue;
                    }

                    

                } else {
                    // 处理常数项
                    const num = parseInt(content, 10);
                    if (isNaN(num)) throw new Error(`Invalid term: ${term}`);
                    let termValue = sign === '+' ? num : -num;
                    expandedTerms.push(termValue);
                    total += termValue;

                }

                
            }   

            // 生成展开表达式字符串
            const expressionParts = expandedTerms.map((val, index) => {   
                if (index === 0) return val.toString();
                return val >= 0 ? `+${val}` : `${val}`;
            });

            return {
                total: total,
                expression: expressionParts.join(' ')
            };
        }


        // 获取页面元素
        
        const buttons = {
            d20: document.getElementById('d20'),
            d10: document.getElementById('d10'),
            d8: document.getElementById('d8'),
            d6: document.getElementById('d6'),
            d4: document.getElementById('d4'),
            d100: document.getElementById('d100'),
        };

        
        // 为每个按钮添加点击事件
        Object.keys(buttons).forEach(diceType => {
            buttons[diceType].addEventListener('click', () => {
                diceInput.value += "+" + buttons[diceType].innerText;
            });
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            diceInput.value = '';
            diceOutput.value = '';
        });

        document.getElementById('rollButton').addEventListener('click', () => {
            result = parseDiceExpression(diceInput.value);
            diceOutput.value = "Expression:" +result.expression + "\n" + "Total: " + result.total;
        });


    </script>
</body>
</html>